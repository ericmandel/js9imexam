<!DOCTYPE HTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge;chrome=1" > 
  <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico">
  <link type="text/css" rel="stylesheet" href="css/jquery.contextMenu.css">
  <link rel="stylesheet" href="css/dhtmlwindow.css" type="text/css">
  <link type="text/css" rel="stylesheet" href="js9.css">
  <script type="text/javascript" src="js/jquery.min.js"></script>
  <script type="text/javascript" src="js/kinetic.min.js"></script>
  <script type="text/javascript" src="js/jquery.contextMenu.min.js"></script>
  <script type="text/javascript" src="js/jquery.flot.min.js"></script>
  <script type="text/javascript" src="js/jquery.flot.errorbars.min.js"></script>
  <script type="text/javascript" src="js/sprintf.min.js"></script>
  <script type="text/javascript" src="js/dhtmlwindow.min.js">
  /***********************************************
  * DHTML Window Widget- Â© Dynamic Drive (www.dynamicdrive.com)
  * This notice must stay intact for legal use.
  * Visit http://www.dynamicdrive.com/ for full source code
  ***********************************************/
  </script>
  <script type="text/javascript" src="js/fitsy.js"></script>
  <script type="text/javascript" src="js9.js"></script>

  <script type="text/javascript" src="js/imexam/template.js"></script>
  <script type="text/javascript" src="js/imexam/imexam.js"></script>

  <!--[if IE]><script type="text/javascript" src="javascript/excanvas.js"></script><![endif]-->
  <script type="text/javascript" src="js/imexam/JSSurfacePlot/javascript/SurfacePlot.js"></script>
  <script type="text/javascript" src="js/imexam/JSSurfacePlot/javascript/ColourGradient.js"></script>

  <script type="text/javascript" src="js/imexam/surface.js"></script>

    <script type="text/template" id="imstat-template">
    <table>
	 <tr><td>Region at</td><td align=right>{reg.pos.x%.2f} , {reg.pos.y%.2f}</td></tr>
	 <tr><td align=right>Size</td>      <td align=right>{reg.size.width%.2f} , {reg.size.height%.2f}</td></tr>
	 <tr><td align=right>Counts</td>    <td align=right>{counts%.2f}	</tr>
	 <tr><td align=right>Background</td><td align=right>{backgr%.2f}</td>	</tr>
	 <tr><td align=right>Noise</td>     <td align=right>{noise%.2f}</td>	</tr>
	 <tr><td align=right>Centroid</td>  <td align=right>{centroid.cenx%.2f}, {centroid.ceny%.2f}</td>	</tr>
	 <tr><td align=right>FWHM</td>  <td align=right>{centroid.fwhm%.2f}</td></tr>
    </table>
    </script>


    <script type="text/template" id="imexam-box-template">
    <form>
	<input type=image class="imexam-pin" src="js/imexam/unpinned.png"
		onclick='imexamPin($(this).parents(".imexam-box")[0]); return false;'>
	<select class="imexam-menu" onchange='imexamUpdate($(this).parents(".imexam-box")[0], undefined, this.options[this.selectedIndex].value);'>
		<option value="stats"> Regions Stats</option>
		<option value="rproj"> Radial Profile</option>
		<option value="3plot"> 3d Plot</option>
		<option value="xproj"> X Projection</option>
		<option value="yproj"> Y Projection</option>
		<option value="histo"> Histogram</option>
	</select>
    </form>
    <div id="imexam-box-display" style="height:280px; width:280px"> </div>
    </script>

</head>
<body>

    <script type="text/javascript">


	imexam = require("./imexam");

    // this is the callback for all region changes
    //
    JS9.regionOpts.xeqonchange = "runImExam";

    function runImExam(im, xreg) {

        switch ( xreg.shape ) {
	    case "box":
	        w = xreg.size.width;
	        h = xreg.size.height;

	        break;
	    case "circle":
	        xreg.size = new Object();

	        xreg.size.width  = xreg.radius*2;
	        xreg.size.height = xreg.radius*2;

	        break;

	    default:
		return;
        }
	
	var im_2d  = imexam.ndarray(im.raw.data, [im.raw.width, im.raw.height]);
	var imstat = imexam.imops.imstat(im_2d
		, imexam.imops.mksection(xreg.pos.x, xreg.pos.y, xreg.size.width, xreg.size.height)
		, xreg.shape);

	imstat.im  = im
	imstat.reg = xreg;
	imstat.jspix = im.raw.data[xreg.pos.y*im.raw.width+xreg.pos.x]
	imstat.impix = im_2d.get(xreg.pos.y, xreg.pos.x)
	imstat.rgpix = imstat.imag.get(xreg.size.width/2, xreg.size.height/2)

	dispImExam(im, xreg, imstat);
    }

    NextType = 0;

    function imexamPin(el) {
	var pinned = $(el).data("pinned");
	var img;

	if ( pinned === undefined || pinned === 0 ) {
	    pinned = 1;
	    img = "js/imexam/pinned.png"
	} else {
	    pinned = 0;
	    img = "js/imexam/unpinned.png"
	}
	
	$(el).find(".imexam-pin")[0].setAttribute("src", img);
	$(el).data("pinned", pinned);
	
    }

    function imexamUpdate(el, imstat, type) {

	if ( type === undefined ) {
	    type = $(el).data("type")

	    if ( type === undefined ) {
		el.innerHTML = template("imexam-box-template", null);

		var menu = $(el).find(".imexam-menu")[0];

		menu.selectedIndex = NextType;
		type = menu.options[NextType].value;
		
		NextType++

		$(el).data("type", type)
	    }
	} else {
	    $(el).data("type", type)
	}

	if ( imstat === undefined ) {
	    imstat = $(el).data("imstat")
	} else {
	    if ( $(el).data("pinned") ) {
		return;
	    }

	    $(el).data("imstat", imstat)
	}

	var box = $(el).find("#imexam-box-display")[0];

	switch ( type ) {
	 case "stats" : {
	    box.innerHTML = template("imstat-template", imstat);
	    break;
	 }
	 case "rproj" : {
	    $.plot(box, [imstat.rdata], { series: {
						points: {
							radius: 1,
							show: true,
						}
						} } );
	    break;
	 }
	 case "xproj" : {
	    $.plot(box, [imstat.xdata], { xaxis: { min: imstat.sect[0][0], max: imstat.sect[0][1] }});
	    break;
	 }
	 case "yproj" : {
	    $.plot(box, [imstat.ydata], { xaxis: { min: imstat.sect[1][0], max: imstat.sect[1][1] }});
	    break;
	 }
	 case "histo" : {
	    $.plot(box, [imstat.hdata]);
	    break;
	 }
	 case "3plot" : {
	    console.log("max", imexam.ndops.maxvalue(imstat.imag))
	    surface(box, imstat.imag);
	    break;
	 }
	 default:
	    console.log("None")
	}
    }

    function dispImExam(im, xreg, imstat) {
        $("#region-info").css("visibility", "visible");

        var x;
        imstat.xdata = [];
        imstat.ydata = [];
        imstat.hdata = [];
        imstat.rdata = [];

        for ( x = 0;  x < imstat.xproj.shape[0]; x++ ) {
	    imstat.xdata[x] = [x+imstat.sect[0][0], imstat.xproj.get(x)]
        }
        for ( x = 0;  x < imstat.yproj.shape[0]; x++ ) {
	    imstat.ydata[x] = [x+imstat.sect[1][0], imstat.yproj.get(x)]
        }
        for ( h = 0;  h < imstat.hist.data.shape[0]; h++ ) {
	    var value = imstat.hist.data.get(h);

	    if ( value ) { imstat.hdata[h] = [h*imstat.hist.width, value] }
        }
        for ( r = 0;  r < imstat.rproj.shape[0]; r++ ) {
	    imstat.rdata[r] = [imstat.rproj.get(r, 0), imstat.rproj.get(r, 1)]
	}


	$(".imexam-box").each(function(i, obj) { imexamUpdate(obj, imstat); });
    }

    </script>

<table>
<tr>
<td>
    <div class="JS9Menubar"></div>
    <div class="JS9"></div>
</td>
<td>
  <div id="region-info" style="visibility:visible">

      <table>
	<tr>
	    <td> <div class="imexam-box" style="height:300px; width:300px"> </div></td>
	    <td> <div class="imexam-box" style="height:300px; width:300px"> </div></td>
	</tr>

	<tr>
	    <td> <div class="imexam-box" style="height:300px; width:300px"></div></td>
	    <td> <div class="imexam-box" style="height:300px; width:300px"></div></td>
	</tr>
      </table>
    </div>
  </div>
</td>
</tr>
</table>

</body>
</html>
